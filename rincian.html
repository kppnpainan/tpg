<!DOCTYPE html> 
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Rincian Penyaluran TPG â€“ KPPN Painan</title>

<style>
  body {
    font-family: Calibri, Arial;
    background:#f2f4f8;
    margin:0;
    padding:40px 20px;
    color:#333;
  }
  h2 {
    text-align:center;
    font-size:24px;
    margin-bottom:25px;
    text-decoration:underline;
  }
  .filter-box {
    max-width:850px;
    margin:auto;
    background:white;
    padding:18px;
    border-radius:12px;
    box-shadow:0 4px 10px rgba(0,0,0,0.08);
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    align-items:center;
    justify-content:center;
  }
  select, button {
    padding:10px 12px;
    border:1px solid #ccc;
    border-radius:8px;
    font-size:14px;
  }
  button {
    background:#1d3557;
    color:white;
    border:none;
    cursor:pointer;
    transition:.2s;
  }
  button:hover {
    background:#16324f;
    transform:scale(1.03);
  }
  .table-wrapper {
    max-width:1100px;
    margin:30px auto;
  }
  table {
    width:100%;
    border-collapse:collapse;
    background:white;
    border-radius:10px;
    overflow:hidden;
    box-shadow:0 3px 10px rgba(0,0,0,0.08);
  }
  th {
    background:#e8eef7;
    padding:12px;
    font-weight:bold;
    text-align:center;
    font-size:14px;
    border-bottom:1px solid #d6d6d6;
  }
  td {
    padding:10px;
    border-bottom:1px solid #eee;
    font-size:14px;
    text-align:center;
  }
  tr:nth-child(even) {
    background:#fafafa;
  }
  tfoot td {
    font-weight:bold;
    background:#eef3fa;
  }
</style>
</head>

<body>

<h2>Rincian Penyaluran TPG KPPN Painan</h2>

<div class="filter-box">
  <span>Periode</span>
  <select id="bulanAwal"></select>
  <select id="tahunAwal"></select>

  <span>-</span>
  <select id="bulanAkhir"></select>
  <select id="tahunAkhir"></select>

  <button onclick="loadData()">Tampilkan</button>
</div>

<div class="table-wrapper">
  <table id="tabelData">
    <thead>
      <tr>
        <th>Jenis</th>
        <th>Tanggal SP2D</th>
        <th>Total Penyaluran</th>
        <th>PPh</th>
        <th>JKN PNS</th>
        <th>JKN P3K</th>
        <th>Detil Penerima</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="7">Memuat data...</td></tr>
    </tbody>
    <tfoot>
      <tr>
        <td colspan="2">TOTAL</td>
        <td id="sumTotalPenyaluran">0</td>
        <td id="sumPPh">0</td>
        <td id="sumJknPns">0</td>
        <td id="sumJknP3k">0</td>
        <td>-</td>
      </tr>
    </tfoot>
  </table>
</div>

<script>
const bulanList = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];

// =========================
//  PARSER TANGGAL PERBAIKAN
// =========================
function parseTanggal(tgl) {
  if (!tgl) return null;
  tgl = tgl.trim();

  // Format dd/mm/yyyy
  if (tgl.includes("/")) {
    const [d, m, y] = tgl.split("/").map(Number);
    return { d, m, y };
  }

  // Format yyyy-mm-dd
  if (tgl.includes("-")) {
    const [y, m, d] = tgl.split("-").map(Number);
    return { d, m, y };
  }

  // Format "25 Maret 2025" atau "03 January 2025"
  const bulanIndo = {
    Januari:1, Februari:2, Maret:3, April:4, Mei:5, Juni:6,
    Juli:7, Agustus:8, September:9, Oktober:10, November:11, Desember:12
  };

  const bulanEng = {
    January:1, February:2, March:3, April:4, May:5, June:6,
    July:7, August:8, September:9, October:10, November:11, December:12
  };

  const parts = tgl.split(" ");

  if (parts.length === 3) {
    const d = Number(parts[0]);
    const namaBulan = parts[1];
    const y = Number(parts[2]);

    const m = bulanIndo[namaBulan] || bulanEng[namaBulan];
    if (!m) return null;

    return { d, m, y };
  }

  return null;
}

// =====================================
//  INISIALISASI FILTER BULAN & TAHUN
// =====================================
function initFilter(){
  bulanList.forEach((b,i)=>{
    bulanAwal.innerHTML += `<option value="${i+1}">${b}</option>`;
    bulanAkhir.innerHTML += `<option value="${i+1}">${b}</option>`;
  });
  [2025,2026,2027].forEach(t=>{
    tahunAwal.innerHTML += `<option value="${t}">${t}</option>`;
    tahunAkhir.innerHTML += `<option value="${t}">${t}</option>`;
  });

  bulanAwal.value = 1;
  bulanAkhir.value = 12;
  tahunAwal.value = 2025;
  tahunAkhir.value = 2025;
}
initFilter();

window.onload = () => loadData();

const API_URL = "https://script.google.com/macros/s/AKfycbylKLAQyLg6hldI31tQxFvVUxvYXf9erl_1jW2qWNcwe0mh9DCBMO590C7z8_UgIA29RQ/exec";

// =============================
//      LOAD DATA DARI API
// =============================
async function loadData(){
  const bAw = parseInt(bulanAwal.value);
  const tAw = parseInt(tahunAwal.value);
  const bAk = parseInt(bulanAkhir.value);
  const tAk = parseInt(tahunAkhir.value);

  document.querySelector("#tabelData tbody").innerHTML =
    `<tr><td colspan="7">Mengambil data...</td></tr>`;

  try {
    const res = await fetch(API_URL);
    const data = await res.json();

    const hasil = data.filter(row => {
      const tgl = row["Tanggal SP2D"];
      const t = parseTanggal(tgl);
      if (!t) return false;

      const current = t.y * 100 + t.m;
      const start = tAw * 100 + bAw;
      const end   = tAk * 100 + bAk;

      return current >= start && current <= end;
    });

    const tbody = document.querySelector("#tabelData tbody");
    tbody.innerHTML = "";

    if (hasil.length === 0){
      tbody.innerHTML = `<tr><td colspan="7">Tidak ada data dalam rentang tersebut.</td></tr>`;
      return;
    }

    let totalPenyaluran = 0;
    let totalPPh = 0;
    let totalJknPns = 0;
    let totalJknP3k = 0;

    hasil.forEach(row=>{
      const nilai = Number(row["Nilai SP2D"]) || 0;
      const pph = Number(row["PPh"]) || 0;
      const jpns = Number(row["Jkn Pns"]) || 0;
      const jp3k = Number(row["Jkn P3k"]) || 0;

      totalPenyaluran += nilai;
      totalPPh += pph;
      totalJknPns += jpns;
      totalJknP3k += jp3k;

      tbody.innerHTML += `
        <tr>
          <td>${row["Jenis"]}</td>
          <td>${row["Tanggal SP2D"]}</td>
          <td>${nilai.toLocaleString("id-ID")}</td>
          <td>${pph.toLocaleString("id-ID")}</td>
          <td>${jpns.toLocaleString("id-ID")}</td>
          <td>${jp3k.toLocaleString("id-ID")}</td>
          <td><a href="${row["Link Drive Penerima"]}" target="_blank">Cek Data</a></td>
        </tr>
      `;
    });

    document.getElementById("sumTotalPenyaluran").textContent = totalPenyaluran.toLocaleString("id-ID");
    document.getElementById("sumPPh").textContent = totalPPh.toLocaleString("id-ID");
    document.getElementById("sumJknPns").textContent = totalJknPns.toLocaleString("id-ID");
    document.getElementById("sumJknP3k").textContent = totalJknP3k.toLocaleString("id-ID");

  } catch (err){
    console.error(err);
    document.querySelector("#tabelData tbody").innerHTML =
      `<tr><td colspan="7" style="color:red;">Terjadi kesalahan memuat data.</td></tr>`;
  }
}
</script>

</body>
</html>
